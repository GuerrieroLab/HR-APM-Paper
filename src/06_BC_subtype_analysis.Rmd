---
title: "6. Looking into the correlation in different cancer types"
# output: html_notebook
---

## Initial setup

### Load libraries
```{r}
suppressPackageStartupMessages({
  library(RColorBrewer)
  library(gplots)
  library(ggplot2)
  library(heatmap3)
  library(GSVA)
  library(dplyr)
  library(tidyr)
  library(ROCR)
})
```


### Load data
```{r}
# x <- load(file=file.path(obj_dir,"1-4_prep","gene_signature.rda")) # gene.sig, category, hallmarks
y <- load(file=file.path(obj_dir,"1-4_prep","tcga_processed_v3.rda")) # meta.ids,meta.clinical,meta.syms,meta.m1,meta.m3
z <- load(file=file.path(obj_dir,"1-4_prep","metabric_processed_v3.rda")) # meta.ids,meta.clinical,meta.syms,meta.m1,meta.m3

tested.gns  <- intersect(tcga.syms,meta.syms)

hallmarks <- c("ESR1","CD8A","HLA-A")
load(file=file.path(obj_dir,"1-4_prep","tcga_metabric_cors.rda")) # tcga.sp,meta.sp

mod.gns <- readRDS(file=file.path(obj_dir,"1-4_prep","module_genes_final_122923.rds"))#[c(1,2,4,3)]
# names(sigs) <- c("ERS","TNFa/NFkB","IFN-I","APM/TC")
sigs <- readRDS(file=file.path(obj_dir,"1-4_prep","modules3_ers_apmtc_cc.rds"))

comm.gns <- unlist(mod.gns)
comm.gns <- unlist(sigs[1:2])
load(file=file.path(obj_dir,"1-4_prep","heatmap_sidecols.rda")) # lcols,slcols
```

## TCGA

### [Fig 1D] Heatmap of 254 module gene correlates
```{r}
## subtypes
ttls <- c("HR+/HER2-","HR-/HER2+","HR+/HER2+","HR-/HER2-")
smpl.class <- names(tcga.sp)
names(ttls) <- smpl.class

tmp <- tcga.sp$hr[comm.gns,comm.gns]

# cols <- colorRampPalette(rev(brewer.pal(11,"RdBu")))(201)
cols <- colorRampPalette(c("navy", "white", "firebrick3"))(1024)

cl <- smpl.cl
hc <- heatmap3(tmp,
         # Colv=dend1,Rowv=dend1,
         ColSideColors=lcols[comm.gns,c(1,3,4)],
         col=cols,
         scale="none",
         balanceColor=TRUE,
         main=paste0(ttls[cl],", (TCGA)"))
comm.gns <- comm.gns[hc$hcr$order]
##
if(1){
  for(cl in smpl.class){
    pdf(file.path(fig_dir,"6_heatmap_bc_subtypes",paste0("tcga_",cl,"_v4.pdf")),
        width=7,height=7)	
  	par(cex.main=3)
  
  	tmp1 <- tcga.sp1 <- tcga.sp[[cl]][comm.gns,comm.gns]
  
    # d.tcga <- as.dist(1-tcga.sp1)
  
  	cgs <- comm.gns
  	cgs[!cgs %in% hallmarks] <- NA
  	
  	rownames(tmp1) <- colnames(tmp1) <- cgs
    heatmap3(tmp1,
             Colv=NA,Rowv=NA,
             # showColDendro=FALSE,showRowDendro=FALSE,
             ColSideColors=lcols[comm.gns,c(1,3,4)],
             col=cols,
             scale="none",
             balanceColor=TRUE,
             main=paste0(ttls[cl],", (TCGA)"))
  	dev.off()
  }
}
```
### [Fig 1E] Heatmap of mean module gene correlates
```{r}
mean.tcga.sp <- list()
cols <- colorRampPalette(c("navy", "white", "firebrick3"))(201)

for(cl in smpl.class){
  tmp <- tcga.sp[[cl]][comm.gns,comm.gns]
  diag(tmp) <- NA
  
  mean.tcga.sp[[cl]] <- sapply(mod.gns,function(x){
    sapply(mod.gns,function(y){
      mean(tmp[x,y],na.rm=T)
    })
  })

  idx <- 1:4
  
  n.max.cor.1 <- round(max(abs(mean.tcga.sp[[cl]]))*100)
  cols1 <- cols[(-100:100) %in% seq(-n.max.cor.1,n.max.cor.1)]
  if(1){
    pdf(file.path(fig_dir,"6_heatmap_bc_subtypes",paste0("mean_tcga_",cl,"_v2.pdf")),
        width=7,height=7)
    hc.t <- heatmap3(mean.tcga.sp[[cl]][idx,idx],Rowv=NA,Colv=NA,dendrogram="none",
              col=cols1,scale="none",distfun=dist,
              ColSideColors=slcols[idx,2:1],
              RowSideColors=slcols[idx,],
              balanceColor = TRUE,
              margins=c(7,7),
              cexRow=1.5,cexCol=1.5,
              main=paste0("TCGA (mean correlation),",cl))
    dev.off()
  }
}
```


## METABRIC

### Heatmap
```{r}
tmp <- meta.sp$hr[comm.gns,comm.gns]
d.meta <- as.dist(1-tmp)

hc2 <- heatmap3(tmp,
         Colv=d.meta,Rowv=d.meta,
         ColSideColors=lcols[comm.gns,],
         col=cols,
         scale="none",
         balanceColor=TRUE)
comm.gns2 <- comm.gns[hc2$rowInd]
cols <- colorRampPalette(rev(brewer.pal(11,"RdBu")))(50)

if(1){
  for(cl in smpl.class){
    cols <- colorRampPalette(c("navy", "white", "firebrick3"))(201)
    
    pdf(file.path(fig_dir,"6_heatmap_bc_subtypes",paste0("meta_",cl,"_v2.pdf")),width=7,height=7)	
  	par(cex.main=3)
  	
  	tmp <- meta.sp1 <- meta.sp[[cl]][comm.gns,comm.gns]
  	
    # d.meta <- as.dist(1-meta.sp1)
  
  	cgs <- comm.gns
  	cgs[!cgs %in% hallmarks] <- NA
  	
  	rownames(tmp) <- colnames(tmp) <- cgs
    heatmap3(tmp,
             # Colv=d.meta,Rowv=d.meta,
             Colv=NA,Rowv=NA,
             ColSideColors=lcols[comm.gns,c(1,3,4)],
             col=cols,
             scale="none",
             balanceColor=TRUE,
             main=paste0(ttls[cl]," (METABRIC)"))
    dev.off()
  }
}
```
### [Fig S2X] heatmap of mean correlations
```{r}
mean.meta.sp <- list()

for(cl in smpl.class){
  tmp <- meta.sp[[cl]][comm.gns,comm.gns]
  diag(tmp) <- NA
  
  mean.meta.sp[[cl]] <- sapply(mod.gns,function(x){
    sapply(mod.gns,function(y){
      mean(tmp[x,y],na.rm=T)
    })
  })

  idx <- 1:4

  n.max.cor.1 <- round(max(abs(mean.meta.sp[[cl]]))*100)
  cols1 <- cols[(-100:100) %in% seq(-n.max.cor.1,n.max.cor.1)]
  # if(0){
    pdf(file.path(fig_dir,"6_heatmap_bc_subtypes",paste0("mean_meta_",cl,"_v2.pdf")),
        width=7,height=7)
    hc.t <- heatmap3(mean.meta.sp[[cl]][idx,idx],Rowv=NA,Colv=NA,dendrogram="none",
              col=cols1,scale="none",distfun=dist,
              ColSideColors=slcols[idx,2:1],
              RowSideColors=slcols[idx,],
              balanceColor = TRUE,
              margins=c(7,7),
              cexRow=1.5,cexCol=1.5,
              main=paste0("METABRIC (mean correlation),",cl))
    dev.off()
  # }
}
```
## Violin plot

## TCGA
### Spearman correlation
```{r}
tcga.sp.panel <- list()
tcga.sp.panel$ers <- 
  tcga.sp.panel[["TNFa/NFkB"]] <- 
  tcga.sp.panel[["IFN-I"]] <- 
  tcga.sp.panel[["APM/TC"]] <- 
  tcga.sp.panel$ers.apmtc1 <- 
  tcga.sp.panel$ers.apmtc2 <- 
  tcga.sp.panel$ers.apmtc3 <- list()

tcga.sp.panel <- tcga.sp.panel[7:1]
tcga.cohens_d <- tcga.pvals1 <- tcga.pvals <- list()

compute_cohens_d <- function(data, hypothesized_mean=0) {
  # Calculate sample mean and sample standard deviation
  sample_mean <- mean(data)
  sample_sd <- sd(data)
  
  # Calculate sample size
  n <- length(data)
  
  # Calculate Cohen's d
  cohen_d <- (sample_mean - hypothesized_mean) / sample_sd
  
  return(cohen_d)
}

for(cl in smpl.class[c(1,3,4,2)]){
	tmp <- tcga.sp[[cl]]
	diag(tmp) <- NA
	
	g1 <- tmp[mod.gns[["ERS"]],mod.gns[["ERS"]]] # 378
	g1 <- g1[lower.tri(g1)]
	g2 <- tmp[mod.gns[["TNFa/NFkB"]],mod.gns[["TNFa/NFkB"]]] # 9045
	g2 <- g2[lower.tri(g2)]
	g3 <- tmp[mod.gns[["IFN-I"]],mod.gns[["IFN-I"]]] # 9045
	g3 <- g3[lower.tri(g3)]
	g4 <- tmp[mod.gns[["APM/TC"]],mod.gns[["APM/TC"]]] # 9045
	g4 <- g4[lower.tri(g4)]
	g5 <- as.vector(tmp[mod.gns[["ERS"]],mod.gns[["TNFa/NFkB"]]])# 3780
	g6 <- as.vector(tmp[mod.gns[["ERS"]],mod.gns[["IFN-I"]]])# 3780
	g7 <- as.vector(tmp[mod.gns[["ERS"]],mod.gns[["APM/TC"]]])# 3780

	tcga.sp.panel$ers[[cl]] <- g1
	tcga.sp.panel[["TNFa/NFkB"]][[cl]] <- g2
	tcga.sp.panel[["IFN-I"]][[cl]] <- g3
	tcga.sp.panel[["APM/TC"]][[cl]] <- g4
	tcga.sp.panel$ers.apmtc1[[cl]] <- g5
	tcga.sp.panel$ers.apmtc2[[cl]] <- g6
	tcga.sp.panel$ers.apmtc3[[cl]] <- g7
	pvals <- sapply(1:7,function(i){
	  obj <- get(paste0("g",i))
	  wilcox.test(obj)$p.value
	})
	pvals1 <- sapply(1:7,function(i){
	  obj <- get(paste0("g",i))
	  t.test(obj)$p.value
	})

	cohend <- sapply(1:7,function(i){
	  obj <- get(paste0("g",i))
	  compute_cohens_d(obj)
	})

	tcga.pvals[[cl]] <- pvals
	tcga.pvals1[[cl]] <- pvals1
	tcga.cohens_d[[cl]] <- cohend
}

tcga.pvals <- do.call(rbind,tcga.pvals)
tcga.pvals1 <- do.call(rbind,tcga.pvals1)
tcga.cohens_d <- round(do.call(rbind,tcga.cohens_d),2)

tcga.ps <- array(rowSums(sapply(c(10,50,250),function(i)-log10(tcga.pvals1)>i)),dim(tcga.pvals1))
```

#### restructure data
```{r}
subtypes <- c("HR+/HER2-","HR+/HER2+","HR-/HER2-","HR-/HER2+") 

names(tcga.sp.panel$ers) <- 
  names(tcga.sp.panel[["TNFa/NFkB"]]) <- 
  names(tcga.sp.panel[["IFN-I"]]) <- 
  names(tcga.sp.panel[["APM/TC"]]) <- 
  names(tcga.sp.panel$ers.apmtc1) <- 
  names(tcga.sp.panel$ers.apmtc2) <- 
  names(tcga.sp.panel$ers.apmtc3) <- subtypes

tcga.sps <- lapply(seq(tcga.sp.panel),function(i){
  n <- names(tcga.sp.panel)[[i]]
  lst <- tcga.sp.panel[[n]]
  tmp <- data.frame(do.call(cbind,lst))
  names(tmp) <- 1:4
  tmp <- tmp %>%
    tidyr::gather("subtype","sp",1:4) %>%
    mutate(type=n)
  return(tmp)
})

tcga.sps <- do.call(rbind,tcga.sps) 
tcga.sps <- tcga.sps %>%
  mutate(subtype=subtypes[as.numeric(subtype)]) %>%
  mutate(subtype=factor(subtype,levels=subtypes)) %>%
  mutate(type=toupper(type))
```

### Violin plot
```{r}
tcga.ps <- array(rowSums(sapply(c(10,50,250),function(i)-log10(tcga.pvals1)>i)),dim(tcga.pvals1))
colnames(tcga.cohens_d) <- colnames(tcga.ps) <- toupper(names(tcga.sp.panel))
rownames(tcga.ps) <- rownames(tcga.pvals1)

df.cd <- data.frame(tcga.cohens_d) %>%
  tibble::rownames_to_column("subtype") %>%
  mutate(subtype=factor(subtype,levels=c("hr","dp","tnbc","her2"))) %>%
  tidyr::gather("type","cohens_d",-1) 
levels(df.cd$subtype) <- subtypes
  
df.txt <- data.frame(tcga.ps) %>%
  tibble::rownames_to_column("subtype") %>%
  mutate(subtype=factor(subtype,levels=c("hr","dp","tnbc","her2"))) %>%
  tidyr::gather("type","txt",-1) %>%
  mutate(txt=sapply(txt,function(i)paste(rep("*",i),collapse=""))) %>%
  mutate(is.hr=factor(subtype %in% c("hr","dp"),levels=c("TRUE","FALSE"))) 
    
levels(df.txt$subtype) <- subtypes

dfx.tcga <- tcga.sps %>% 
  left_join(df.txt,by=c("subtype","type")) %>%
  left_join(df.cd,by=c("subtype","type")) %>%
  mutate(txt = paste0(txt,"\n(",cohens_d,")"))
```


```{r}
subtype_violin <- function(dfx,mod){
  p0 <- ggplot(dfx %>% filter(type==mod),aes(x=subtype,y=sp,fill=is.hr)) +
    geom_hline(yintercept=0) + 
    geom_violin(position="dodge") +
    scale_fill_manual(values=brewer.pal(4,"YlOrBr")[c(3,1)])+
    theme_bw() +
    ggtitle(paste0("Spearman within ",mod)) +
    geom_text(aes(x=subtype,label=txt),y=1.1,size=4) + 
    scale_y_continuous(limits=c(-.7,1)) +
    ylim(c(-.7,1.2)) +
    xlab("") +
    ylab("Spearman correlation") +
    theme(legend.position="none",
          plot.title=element_text(hjust=0.5,size=12),
          text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))   
  print(p0)
}

subtype_violin_bt <- function(dfx,mod){
  if(!mod %in% c("TNFa/NFkB", "IFN-I", "APM/TC")){
    stop("mod should be one of the immune module names")
  }
  mods <- paste0("APMTC",1:3)
  mod1 <- mods[match(mod,c("TNFa/NFkB", "IFN-I", "APM/TC"))]
  p0 <- ggplot(dfx %>% filter(type==paste0("ERS.",mod1)),
               aes(x=subtype,y=sp,fill=is.hr)) +
    geom_hline(yintercept=0) + 
    geom_violin(position="dodge") +
    scale_fill_manual(values=brewer.pal(4,"YlOrBr")[c(3,1)])+
    theme_bw() +
    ggtitle(paste0("Cor, ERS vs ",mod)) +
    geom_text(aes(x=subtype,label=txt),y=1.1,size=4) + 
    scale_y_continuous(limits=c(-.7,1)) +
    ylim(c(-.7,1.2)) +
    xlab("") +
    ylab("Spearman correlation") +
    theme(legend.position="none",
          plot.title=element_text(hjust=0.5,size=12),
          text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))   
  print(p0)
}

# subtype_violin(dfx=dfx.tcga,mod="ERS")
# subtype_violin_bt(mod="TNFa/NFkB")
# subtype_violin_bt(mod="IFN-I")
# subtype_violin_bt(mod="APM/TC")

if(1){
  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_ers.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.tcga,mod="ERS")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_apmtc1.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.tcga,mod="TNFa/NFkB")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_apmtc2.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.tcga,mod="IFN-I")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_apmtc3.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.tcga,mod="APM/TC")
  dev.off()
}
  
if(1){
  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_ers_apmtc1.pdf"),width=3,height=6)
  subtype_violin_bt(dfx=dfx.tcga,mod="TNFa/NFkB")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_ers_apmtc2.pdf"),width=3,height=6)
  subtype_violin_bt(dfx=dfx.tcga,mod="IFN-I")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_ers_apmtc3.pdf"),width=3,height=6)
  subtype_violin_bt(dfx=dfx.tcga,mod="APM/TC")
  dev.off()
}
```

## METABRIC
### Spearman correlation
```{r}
meta.sp.panel <- list()
meta.sp.panel$ers <- 
  meta.sp.panel[["TNFa/NFkB"]] <- 
  meta.sp.panel[["IFN-I"]] <- 
  meta.sp.panel[["APM/TC"]] <- 
  meta.sp.panel$ers.apmtc1 <- 
  meta.sp.panel$ers.apmtc2 <- 
  meta.sp.panel$ers.apmtc3 <- list()

meta.sp.panel <- meta.sp.panel[7:1]
meta.cohens_d <- meta.pvals1 <- meta.pvals <- list()

compute_cohens_d <- function(data, hypothesized_mean=0) {
  # Calculate sample mean and sample standard deviation
  sample_mean <- mean(data)
  sample_sd <- sd(data)
  
  # Calculate sample size
  n <- length(data)
  
  # Calculate Cohen's d
  cohen_d <- (sample_mean - hypothesized_mean) / sample_sd
  
  return(cohen_d)
}

for(cl in smpl.class[c(1,3,4,2)]){
	tmp <- meta.sp[[cl]]
	diag(tmp) <- NA
	
	g1 <- tmp[mod.gns[["ERS"]],mod.gns[["ERS"]]] # 378
	g1 <- g1[lower.tri(g1)]
	g2 <- tmp[mod.gns[["TNFa/NFkB"]],mod.gns[["TNFa/NFkB"]]] # 9045
	g2 <- g2[lower.tri(g2)]
	g3 <- tmp[mod.gns[["IFN-I"]],mod.gns[["IFN-I"]]] # 9045
	g3 <- g3[lower.tri(g3)]
	g4 <- tmp[mod.gns[["APM/TC"]],mod.gns[["APM/TC"]]] # 9045
	g4 <- g4[lower.tri(g4)]
	g5 <- as.vector(tmp[mod.gns[["ERS"]],mod.gns[["TNFa/NFkB"]]])# 3780
	g6 <- as.vector(tmp[mod.gns[["ERS"]],mod.gns[["IFN-I"]]])# 3780
	g7 <- as.vector(tmp[mod.gns[["ERS"]],mod.gns[["APM/TC"]]])# 3780

	meta.sp.panel$ers[[cl]] <- g1
	meta.sp.panel[["TNFa/NFkB"]][[cl]] <- g2
	meta.sp.panel[["IFN-I"]][[cl]] <- g3
	meta.sp.panel[["APM/TC"]][[cl]] <- g4
	meta.sp.panel$ers.apmtc1[[cl]] <- g5
	meta.sp.panel$ers.apmtc2[[cl]] <- g6
	meta.sp.panel$ers.apmtc3[[cl]] <- g7
	pvals <- sapply(1:7,function(i){
	  obj <- get(paste0("g",i))
	  wilcox.test(obj)$p.value
	})
	pvals1 <- sapply(1:7,function(i){
	  obj <- get(paste0("g",i))
	  t.test(obj)$p.value
	})

	cohend <- sapply(1:7,function(i){
	  obj <- get(paste0("g",i))
	  compute_cohens_d(obj)
	})

	meta.pvals[[cl]] <- pvals
	meta.pvals1[[cl]] <- pvals1
	meta.cohens_d[[cl]] <- cohend
}

meta.pvals <- do.call(rbind,meta.pvals)
meta.pvals1 <- do.call(rbind,meta.pvals1)
meta.cohens_d <- round(do.call(rbind,meta.cohens_d),2)

meta.ps <- array(rowSums(sapply(c(10,50,250),function(i)-log10(meta.pvals1)>i)),dim(meta.pvals1))
```

#### restructure data
```{r}
subtypes <- c("HR+/HER2-","HR+/HER2+","HR-/HER2-","HR-/HER2+") 

names(meta.sp.panel$ers) <- 
  names(meta.sp.panel[["TNFa/NFkB"]]) <- 
  names(meta.sp.panel[["IFN-I"]]) <- 
  names(meta.sp.panel[["APM/TC"]]) <- 
  names(meta.sp.panel$ers.apmtc1) <- 
  names(meta.sp.panel$ers.apmtc2) <- 
  names(meta.sp.panel$ers.apmtc3) <- subtypes

meta.sps <- lapply(seq(meta.sp.panel),function(i){
  n <- names(meta.sp.panel)[[i]]
  lst <- meta.sp.panel[[n]]
  tmp <- data.frame(do.call(cbind,lst))
  names(tmp) <- 1:4
  tmp <- tmp %>%
    tidyr::gather("subtype","sp",1:4) %>%
    mutate(type=n)
  return(tmp)
})

meta.sps <- do.call(rbind,meta.sps) 
meta.sps <- meta.sps %>%
  mutate(subtype=subtypes[as.numeric(subtype)]) %>%
  mutate(subtype=factor(subtype,levels=subtypes)) %>%
  mutate(type=toupper(type))
```

### Violin plot
```{r}
meta.ps <- array(rowSums(sapply(c(10,50,250),function(i)-log10(meta.pvals1)>i)),dim(meta.pvals1))
colnames(meta.cohens_d) <- colnames(meta.ps) <- toupper(names(meta.sp.panel))
rownames(meta.ps) <- rownames(meta.pvals1)

df.cd <- data.frame(meta.cohens_d) %>%
  tibble::rownames_to_column("subtype") %>%
  mutate(subtype=factor(subtype,levels=c("hr","dp","tnbc","her2"))) %>%
  tidyr::gather("type","cohens_d",-1) 
levels(df.cd$subtype) <- subtypes
  
df.txt <- data.frame(meta.ps) %>%
  tibble::rownames_to_column("subtype") %>%
  mutate(subtype=factor(subtype,levels=c("hr","dp","tnbc","her2"))) %>%
  tidyr::gather("type","txt",-1) %>%
  mutate(txt=sapply(txt,function(i)paste(rep("*",i),collapse=""))) %>%
  mutate(is.hr=factor(subtype %in% c("hr","dp"),levels=c("TRUE","FALSE"))) 
    
levels(df.txt$subtype) <- subtypes

dfx.meta <- meta.sps %>% 
  left_join(df.txt,by=c("subtype","type")) %>%
  left_join(df.cd,by=c("subtype","type")) %>%
  mutate(txt = paste0(txt,"\n(",cohens_d,")"))

if(1){
  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_ers.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.meta,mod="ERS")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_apmtc1.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.meta,mod="TNFa/NFkB")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_apmtc2.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.meta,mod="IFN-I")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_apmtc3.pdf"),width=3,height=6)
  subtype_violin(dfx=dfx.meta,mod="APM/TC")
  dev.off()
}
  
if(1){
  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_ers_apmtc1.pdf"),width=3,height=6)
  subtype_violin_bt(dfx=dfx.meta,mod="TNFa/NFkB")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_ers_apmtc2.pdf"),width=3,height=6)
  subtype_violin_bt(dfx=dfx.meta,mod="IFN-I")
  dev.off()

  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_ers_apmtc3.pdf"),width=3,height=6)
  subtype_violin_bt(dfx=dfx.meta,mod="APM/TC")
  dev.off()
}
```

## ESR1 expression per subclass
```{r}
threshold1 <- function(predict, response) {
    perf <- ROCR::performance(ROCR::prediction(predict, response), "sens", "spec")
    df <- data.frame(cut = perf@alpha.values[[1]], sens = perf@x.values[[1]], spec = perf@y.values[[1]])
    df[which.max(df$sens + df$spec), "cut"]
}
```

### TCGA
```{r}
ers.exp <- tcga.m3[match("ESR1",tcga.syms),unlist(tcga.ids[c(1,3,2,4)])]
cls <- factor(rep(subtypes,sapply(tcga.ids[c(1,3,2,4)],length)),
	levels=subtypes)

df.t <- data.frame(esr1=ers.exp,class=cls)

exp.pos <- (df.t %>% filter(class %in% c("HR+/HER2-","HR+/HER2+")))$esr1
exp.neg <- (df.t %>% filter(class %in% c("HR-/HER2-","HR-/HER2+")))$esr1

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))

th <- threshold1(predictions,labels)

if(0){
  pdf(file.path(fig_dir,"6_violin_bc_subtypes","tcga_esr1_bc_subtypes_v2.pdf"),width=4,height=7)
  p <- ggplot(df.t,aes(class,esr1)) + 
  	geom_violin(fill='grey80') +
  	geom_jitter(height = 0, width = 0.2,size=.5) +
  	labs(title="ESR1 gene (TCGA)",
          x ="", y = "Expression (log, z-score)") +
    geom_hline(yintercept = th,linetype="dashed") +
    theme_bw() +
    theme(plot.title=element_text(hjust=0.5),
          text = element_text(size = 15),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))    
  
  p
  dev.off()
}
```

### METABRIC
```{r}
ers.exp <- meta.m3[match("ESR1",meta.syms),unlist(meta.ids[c(1,3,2,4)])]
cls <- factor(rep(subtypes,sapply(meta.ids[c(1,3,4,2)],length)),
	levels=subtypes)

df.m <- data.frame(esr1=ers.exp,class=cls)

exp.pos <- (df.m %>% filter(class %in% c("HR+/HER2-","HR+/HER2+")))$esr1
exp.neg <- (df.m %>% filter(class %in% c("HR-/HER2-","HR-/HER2+")))$esr1

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))

th <- threshold1(predictions,labels)

if(0){
  pdf(file.path(fig_dir,"6_violin_bc_subtypes","meta_esr1_bc_subtypes.pdf"),width=4,height=7)
  p <- ggplot(df.m,aes(class,esr1)) + 
  	geom_violin(fill='grey80') +
  	geom_jitter(height = 0, width = 0.2,size=.5) +
  	labs(title="ESR1 gene (METABRIC)",
          x ="", y = "Expression (log, z-score)") +
    geom_hline(yintercept = th,linetype="dashed") +
    theme_bw() +
    theme(plot.title=element_text(hjust=0.5),
          text = element_text(size = 15),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))    
  p
  dev.off()
}
```
## GSVA

### Run gsva for both TCGA and METABRIC
```{r}
gs <- lapply(sigs,identity)
mthds <- c("gsva", "ssgsea", "zscore", "plage")

lst.tcga.gs <- lst.meta.gs <- list()

if(0){
  for(mth in mthds){
    lst.tcga.gs[[mth]] <-  GSVA::gsva(expr = tcga.m3[tested.gns,],
                 gset.idx.list = gs, method = mth,
                 min.sz = 10, max.sz = 500, kcdf = "Gaussian")
    
    lst.meta.gs[[mth]] <-  GSVA::gsva(expr = meta.m3[tested.gns,],
                 gset.idx.list = gs, method = mth,
                 min.sz = 10, max.sz = 500, kcdf = "Gaussian")
  }
  save(lst.tcga.gs,lst.meta.gs,file=file.path(obj_dir,"1-4_prep","tcga_meta_ssgsea_scores.rda"))
}else{
  load(file=file.path(obj_dir,"1-4_prep","tcga_meta_ssgsea_scores.rda"))
}
if(0){
  identical(rownames(df.t),colnames(lst.tcga.gs[[mth]])) # NO
  
  ## tcga
  esr <- df.t$esr1
  aers1 <- t(lst.tcga.gs[[1]])[rownames(df.t),"ERS"]
  ers3 <- t(lst.tcga.gs[[3]])[rownames(df.t),"ERS"]  
  boxplot(esr ~ df.t$class)
  plot(ers1,ers3)
  
  ## meta
  esr <- df.m$esr1
  ers1 <- t(lst.meta.gs[[1]])[rownames(df.m),"ERS"]
  ers3 <- t(lst.meta.gs[[3]])[rownames(df.m),"ERS"]  
  boxplot(ers ~ df.m$class)
  plot(esr,ers)
  plot(ers1,ers3)
  
  cors.t <- sapply(mthds,function(mth){
    esr <- df.t$esr1
    cor(esr,t(lst.tcga.gs[[mth]])[rownames(df.t),])
  })
  
  cors.m <- sapply(mthds,function(mth){
    esr <- df.m$esr1
    cor(esr,t(lst.meta.gs[[mth]])[rownames(df.m),])
  })
  rownames(cors.t) <- rownames(cors.m) <- names(sigs)
  
  round(cors.t,3)
  round(cors.m,3)
}
```

### 1D/2D plots - functions
```{r}
xx <- source(file.path(src_dir,"plot_module_scores.R"))
```

### TCGA - GSVA plot
```{r}
esr1.exp <- tcga.m3[match("ESR1",tcga.syms),unlist(tcga.ids[c(1,3,2,4)])]

df0 <- data.frame(ESR1=esr1.exp) %>% tibble::rownames_to_column("id")
df2 <- data.frame(id=unlist(tcga.ids),mod=rep(names(tcga.ids),sapply(tcga.ids,length))) %>%
  left_join(df0,by="id") %>%
  mutate(mod=factor(mod,levels=c("hr","dp","tnbc","her2")))
levels(df2$mod) <- c("HR+/HER2-","HR+/HER2+","HR-/HER2-","HR-/HER2+")

exp.pos <- (df2 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ESR1
exp.neg <- (df2 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ESR1

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
pred <- prediction(predictions,labels)

perf <- performance(pred, "tpr", "fpr")
perf

th <- threshold1(predictions,labels) # threshold for ESR1
``` 

```{r}
tcga.gs <- lst.tcga.gs[["zscore"]] # gsva or zscore

df0 <- data.frame(t(tcga.gs)) %>% tibble::rownames_to_column("id")
df1 <- data.frame(id=unlist(tcga.ids),mod=rep(names(tcga.ids),sapply(tcga.ids,length))) %>%
  left_join(df0,by="id") %>%
  # rename(ERS="ers") %>%
  mutate(mod=factor(mod,levels=c("hr","dp","tnbc","her2"))) %>%
  mutate(is.hr=factor(mod %in% c("hr","dp"),levels=c("TRUE","FALSE"))) %>%
  left_join(df2[c(1,3)],by="id")
levels(df1$mod) <- c("HR+/HER2-","HR+/HER2+","HR-/HER2-","HR-/HER2+")

exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ERS
exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ERS

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
pred <- prediction(predictions,labels)

perf <- performance(pred, "tpr", "fpr")
perf

th.ers <- threshold1(predictions,labels) # threshold for ESR1

##
x.th <- "ESR1"
exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))[[x.th]]
exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))[[x.th]]

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
if(x.th %in% c("ERS","ESR1")){
  labels <- labels
}else{
  labels <- -labels
}
th.esr1 <- threshold1(predictions,labels)

df1 <- df1 %>%
  mutate(ers.pos = ERS > th.ers) %>%
  mutate(esr.pos = ESR1 > th.esr1)
```


```{r}
pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_violin_ers.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="ERS")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_violin_apmtc1.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="TNFa.NFkB")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_violin_apmtc2.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="IFN.I")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_violin_apmtc3.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="APM.TC")
dev.off()
```


```{r}
# pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_esr1_vs_ers_v2.pdf"),width=7,height=7)
# my_plot_d2_th2(data=df1,x1="ESR1",x2="ERS")
# dev.off()
# 
# pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc1.pdf"),width=7,height=7)
# my_plot_d2_th(data=df1,x1="ERS",x2="TNFa.NFkB")
# dev.off()
# 
# pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc2.pdf"),width=7,height=7)
# my_plot_d2_th(data=df1,x1="ERS",x2="IFN.I")
# dev.off()
# 
# pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc3.pdf"),width=7,height=7)
# my_plot_d2_th(data=df1,x1="ERS",x2="APM.TC")
# dev.off()
```

#### between immune modules
```{r}
ers.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ERS
ers.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ERS

lm1 <- lm(APM.TC ~ TNFa.NFkB,data=df1 %>% filter(ers.pos))
lm2 <- lm(APM.TC ~ TNFa.NFkB,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=-12,y=10,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=7,y=-15,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="TNFa.NFkB",x2="APM.TC",draw.th=F,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_apmtc1_vs_apmtc3_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```


```{r}
lm1 <- lm(APM.TC ~ IFN.I,data=df1 %>% filter(ers.pos))
lm2 <- lm(APM.TC ~ IFN.I,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=-10,y=10,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=7,y=-18,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="IFN.I",x2="APM.TC",draw.th=F,x.th="ERS")+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_apmtc2_vs_apmtc3_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```


```{r}
lm1 <- lm(IFN.I ~ TNFa.NFkB,data=df1 %>% filter(ers.pos))
lm2 <- lm(IFN.I ~ TNFa.NFkB,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=-12,y=10,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=7,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3_th(data=df1,x1="TNFa.NFkB",x2="IFN.I",draw.th=T,x.th="ERS") +
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_apmtc1_vs_apmtc2_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```
```{r}
th <- function(x){
  exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))[[x]]
  exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))[[x]]
  
  predictions <- c(exp.pos,exp.neg)
  labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
  
  if(x %in% c("ERS","ESR1")){
    labels <- labels
  }else{
    labels <- -labels
  }
  
  pred <- prediction(predictions,labels)
  
  perf <- performance(pred, "tpr", "fpr")
  
  th <- threshold1(predictions,labels)
  return(th)
}

th1 <- th("TNFa.NFkB")
th2 <- th("IFN.I")
df1 <- df1 %>%
  mutate(cat = c("Neg","NFkB","IFN-I","N+I")[(TNFa.NFkB > th1) + (IFN.I > th2)*2 + 1]) %>%
  mutate(cat =factor(cat,levels=c("Neg","NFkB","IFN-I","N+I")))

ucols <- slcols[,"immune"]
ucols[1] <- "grey80"
ucols[4] <- brewer.pal(4,"Accent")[4]
names(ucols) <- levels(df1$cat)

idx <- list(c(1,2),c(2,3),c(3,4),c(1,3),c(2,4),c(1,4))
levs <- levels(df1$cat)
pvals <- rep(NA,length(idx))
for(i in seq(idx)){
  this <- levels(df1$cat)[idx[[i]]]
  t1 <- df1 %>% filter(cat ==this[1]) %>% pull(APM.TC)
  t2 <- df1 %>% filter(cat ==this[2]) %>% pull(APM.TC)  
  pvals[i] <- signif(t.test(t1,t2,alternative="less")$p.value,3)
}
mid.i <- sapply(idx,mean)
ps <- data.frame(i=seq(mid.i),
                 x1=sapply(idx,function(x)x[1]) + .05,
                 x2=sapply(idx,function(x)x[2]) - .05,
                 x.mid = mid.i,
                 y1=c(1,1,1,2,3,4) * 3 + 25,
                 y2=c(1,1,1,2,3,4) * 3 + 25,
                 p.val=pvals)

p <- ggplot(df1,aes(x=cat,y=APM.TC)) +
  geom_violin(position="dodge",aes(fill=cat)) +
  scale_fill_manual(values=ucols) +
  geom_jitter(width=.2,size=.5) +
  geom_segment(data=ps,aes(x=x1,xend=x2,y=y1,yend=y2,group=i))+
  geom_text(data=ps,aes(x=x.mid,y=y1+1.2,label=p.val)) +
  theme_bw() +
  xlab("") +
  ylab("") + 
  ggtitle("") +
  theme(plot.title=element_text(hjust=0.5),
    text = element_text(size = 20),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
    legend.position="none")  

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_violin_apmtc.pdf"),width=5,height=7)
print(p)
dev.off()

```
#### multivariate regression
```{r}
lm1 <- lm(APM.TC ~ TNFa.NFkB + IFN.I + TNFa.NFkB:IFN.I,data=df1)
summary(lm1)$coefficient
```


#### between ERS and ESR1

```{r}
exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ESR1
exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ESR1
  
lm1 <- lm(ERS ~ ESR1,data=df1 %>% filter(esr.pos))
lm2 <- lm(ERS ~ ESR1,data=df1 %>% filter(!esr.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=.8,y=-6,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),esr.pos=TRUE)
txt2 <- data.frame(x=-2,y=2,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),esr.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ESR1",x2="ERS",draw.th=TRUE,x.th="ESR1",split.lm=TRUE) +
  geom_text(data=txt,aes(x=x,y=y,label=label),size=5,color=1)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_esr1_vs_ers_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```
#### between ERS and immune modules

```{r}
lm1 <- lm(TNFa.NFkB ~ ERS,data=df1 %>% filter(ers.pos))
lm2 <- lm(TNFa.NFkB ~ ERS,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=5,y=15,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=-10,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ERS",x2="TNFa.NFkB",draw.th=TRUE,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc1_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```

```{r}
lm1 <- lm(IFN.I ~ ERS,data=df1 %>% filter(ers.pos))
lm2 <- lm(IFN.I ~ ERS,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=5,y=15,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=-10,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ERS",x2="IFN.I",draw.th=TRUE,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc2_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```

```{r}
lm1 <- lm(APM.TC ~ ERS,data=df1 %>% filter(ers.pos))
lm2 <- lm(APM.TC ~ ERS,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=5,y=15,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=-10,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ERS",x2="APM.TC",draw.th=TRUE,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc3_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```

### test
```{r}
# p <- my_plot_d2_col(data=df1,x1="TNFa.NFkB",x2="IFN.I",x.col="APM.TC") +
#     geom_smooth(method="lm",color=1,span=.8) +
#     geom_text(data=txt,aes(x=x,y=y,label=label),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_d2_apmtc-col_v2.pdf"),width=7,height=7)
print(p)
dev.off()

# pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_d2_ers-col.pdf"),width=7,height=7)
# my_plot_d2_col(data=df1,x1="TNFa.NFkB",x2="IFN.I",x.col="ERS")
# dev.off()
```

```{r}
pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc3.pdf"),width=7,height=7)
my_plot_d2_col(data=df1,x1="ERS",x2="APM.TC",x.col="TNFa.NFkB")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc3.pdf"),width=7,height=7)
my_plot_d2_col(data=df1,x1="ERS",x2="APM.TC",x.col="IFN.I")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","tcga_ers_vs_apmtc3.pdf"),width=7,height=7)
my_plot_d2_col(data=df1,x1="ERS",x2="IFN.I",x.col="APM.TC")
dev.off()
```


```{r}
ucols <- slcols[,"immune"]
ucols[1] <- "grey80"
ucols[4] <- brewer.pal(4,"Accent")[4]
names(ucols) <- levels(df1$idx)

my_plot_v <- function(data, x1,x2,ucols){
  p <- ggplot(data,aes(x=!!sym(x1),y=!!sym(x2))) +
    geom_violin(position="dodge",aes(fill=!!sym(x1))) +
    scale_fill_manual(values=ucols) +
    geom_jitter(width=.2,size=.5) +
    theme_bw() +
    xlab("") +
    ylab(paste0(x2," activity")) +
    ggtitle("") +
    theme(plot.title=element_text(hjust=0.5),
      text = element_text(size = 20),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
      legend.position="none")  
  
  return(p)  
}
```


```{r}
th1 <- th(df1,"TNFa.NFkB")
th2 <- th(df1,"IFN.I")

idx <- (df1$TNF > th1) + (df1$IFN > th2) * 2
df1$idx <- factor(idx,labels=c("Neg","TNF","IFN","DP"))

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_vs_tnf-ifn","tcga_ers.pdf"),width=7,height=7)
my_plot_v(data=df1,x1="idx",x2="ERS",ucols=ucols)
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_vs_tnf-ifn","tcga_apmtc.pdf"),width=7,height=7)
my_plot_v(data=df1,x1="idx",x2="APM.TC",ucols=ucols)
dev.off()


```

```{r}
th1 <- th(df1,"ERS")
th2 <- th(df1,"IFN.I")

idx <- (df1$ERS > th1) + (df1$IFN > th2) * 2 
idx <- factor(idx,labels=c("Neg","ERS","IFN","ERS.IFN"))

##
boxplot(df1$APM.TC ~ idx,las=2)
boxplot(df1$ERS ~ idx)
```

```{r}
th1 <- th(df1,"ERS")
th2 <- th(df1,"IFN.I")
th3 <- th(df1,"TNFa.NFkB")

idx <- (df1$ERS > th1) + (df1$IFN > th2) * 2 + (df1$TNF > th3) * 4
idx <- factor(idx,levels=c(1,3,5,7,2,4,6,8)-1)
levels(idx) <- c("Neg","ERS","IFN","ERS.IFN","TNF","ERS.TNF","TNF.IFN","ERS.IFN.TNF")[c(1,3,5,7,2,4,6,8)]

boxplot(df1$APM.TC ~ idx,las=2)
boxplot(df1$ERS ~ idx,las=2)

lm1 <- lm(APM.TC ~ IFN.I + TNFa.NFkB, data=df1)
summary(lm1)

lm2 <- lm(APM.TC ~ ERS + IFN.I + TNFa.NFkB, data=df1)
summary(lm2)

lm3 <- lm(ERS ~ APM.TC + IFN.I + TNFa.NFkB, data=df1)
summary(lm3)

summary(lm1)$adj.r.squared # 0.627
summary(lm2)$adj.r.squared # 0.647
```

```{r}
ids <- tapply(df1$id,df1$idx,identity)
saveRDS(ids,file.path(obj_dir,"1-4_prep","tcga_pts-ids-immune.rds"))
```

### METABRIC - GSVA plot
```{r}
esr1.exp <- meta.m3[match("ESR1",meta.syms),unlist(meta.ids[c(1,3,2,4)])]

df0 <- data.frame(ESR1=esr1.exp) %>% tibble::rownames_to_column("id")
df2 <- data.frame(id=unlist(meta.ids),mod=rep(names(meta.ids),sapply(meta.ids,length))) %>%
  left_join(df0,by="id") %>%
  mutate(mod=factor(mod,levels=c("hr","dp","tnbc","her2")))
levels(df2$mod) <- c("HR+/HER2-","HR+/HER2+","HR-/HER2-","HR-/HER2+")

```

```{r}
meta.gs <- lst.meta.gs[["zscore"]] # gsva or zscore

df0 <- data.frame(t(meta.gs)) %>% tibble::rownames_to_column("id")
df1 <- data.frame(id=unlist(meta.ids),mod=rep(names(meta.ids),sapply(meta.ids,length))) %>%
  left_join(df0,by="id") %>%
  # rename(ERS="ers") %>%
  mutate(mod=factor(mod,levels=c("hr","dp","tnbc","her2"))) %>%
  left_join(df2[c(1,3)],by="id")
levels(df1$mod) <- c("HR+/HER2-","HR+/HER2+","HR-/HER2-","HR-/HER2+")
```

```{r}
exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ERS
exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ERS

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
pred <- prediction(predictions,labels)

perf <- performance(pred, "tpr", "fpr")
perf

th.ers <- threshold1(predictions,labels) # threshold for ESR1

##
x.th <- "ESR1"
exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))[[x.th]]
exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))[[x.th]]

predictions <- c(exp.pos,exp.neg)
labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
if(x.th %in% c("ERS","ESR1")){
  labels <- labels
}else{
  labels <- -labels
}
th.esr1 <- threshold1(predictions,labels)
```

```{r}
df1 <- df1 %>%  
  mutate(ers.pos = ERS > th.ers) %>%
  mutate(esr1.pos = ESR1 > th.esr1) %>%
  mutate(is.hr = mod %in% c("HR+/HER2-","HR+/HER2+"))
```

#### between immune modules
```{r}
ers.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ERS
ers.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ERS

lm1 <- lm(APM.TC ~ TNFa.NFkB,data=df1 %>% filter(ers.pos))
lm2 <- lm(APM.TC ~ TNFa.NFkB,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=-12,y=10,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=7,y=-15,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="TNFa.NFkB",x2="APM.TC",draw.th=F,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_apmtc1_vs_apmtc3_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```


```{r}
lm1 <- lm(APM.TC ~ IFN.I,data=df1 %>% filter(ers.pos))
lm2 <- lm(APM.TC ~ IFN.I,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=-10,y=10,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=7,y=-18,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="IFN.I",x2="APM.TC",draw.th=F,x.th="ERS")+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_apmtc2_vs_apmtc3_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```


```{r}
lm1 <- lm(IFN.I ~ TNFa.NFkB,data=df1 %>% filter(ers.pos))
lm2 <- lm(IFN.I ~ TNFa.NFkB,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=-12,y=10,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=7,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3_th(data=df1,x1="TNFa.NFkB",x2="IFN.I",draw.th=T,x.th="ERS") +
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_apmtc1_vs_apmtc2_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```
```{r}
th <- function(x){
  exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))[[x]]
  exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))[[x]]
  
  predictions <- c(exp.pos,exp.neg)
  labels <- rep(c(1,-1),c(length(exp.pos),length(exp.neg)))
  
  if(x %in% c("ERS","ESR1")){
    labels <- labels
  }else{
    labels <- -labels
  }
  
  pred <- prediction(predictions,labels)
  
  perf <- performance(pred, "tpr", "fpr")
  
  th <- threshold1(predictions,labels)
  return(th)
}

th1 <- th("TNFa.NFkB")
th2 <- th("IFN.I")
df1 <- df1 %>%
  mutate(cat = c("Neg","NFkB","IFN-I","N+I")[(TNFa.NFkB > th1) + (IFN.I > th2)*2 + 1]) %>%
  mutate(cat =factor(cat,levels=c("Neg","NFkB","IFN-I","N+I")))

ucols <- slcols[,"immune"]
ucols[1] <- "grey80"
ucols[4] <- brewer.pal(4,"Accent")[4]
names(ucols) <- levels(df1$cat)

idx <- list(c(1,2),c(2,3),c(3,4),c(1,3),c(2,4),c(1,4))
levs <- levels(df1$cat)
pvals <- rep(NA,length(idx))
for(i in seq(idx)){
  this <- levels(df1$cat)[idx[[i]]]
  t1 <- df1 %>% filter(cat ==this[1]) %>% pull(APM.TC)
  t2 <- df1 %>% filter(cat ==this[2]) %>% pull(APM.TC)  
  pvals[i] <- signif(t.test(t1,t2,alternative="less")$p.value,3)
}
mid.i <- sapply(idx,mean)
ps <- data.frame(i=seq(mid.i),
                 x1=sapply(idx,function(x)x[1]) + .05,
                 x2=sapply(idx,function(x)x[2]) - .05,
                 x.mid = mid.i,
                 y1=c(1,1,1,2,3,4) * 3 + 25,
                 y2=c(1,1,1,2,3,4) * 3 + 25,
                 p.val=pvals)

p <- ggplot(df1,aes(x=cat,y=APM.TC)) +
  geom_violin(position="dodge",aes(fill=cat)) +
  scale_fill_manual(values=ucols) +
  geom_jitter(width=.2,size=.5) +
  geom_segment(data=ps,aes(x=x1,xend=x2,y=y1,yend=y2,group=i))+
  geom_text(data=ps,aes(x=x.mid,y=y1+1.2,label=p.val)) +
  theme_bw() +
  xlab("") +
  ylab("") + 
  ggtitle("") +
  theme(plot.title=element_text(hjust=0.5),
    text = element_text(size = 20),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
    legend.position="none")  

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_violin_apmtc.pdf"),width=5,height=7)
print(p)
dev.off()

```
#### multivariate regression
```{r}
lm1 <- lm(APM.TC ~ TNFa.NFkB + IFN.I + TNFa.NFkB:IFN.I,data=df1)
summary(lm1)$coefficient
```
#### between ERS and ESR1

```{r}
exp.pos <- (df1 %>% filter(mod %in% c("HR+/HER2-","HR+/HER2+")))$ESR1
exp.neg <- (df1 %>% filter(mod %in% c("HR-/HER2-","HR-/HER2+")))$ESR1
  
lm1 <- lm(ERS ~ ESR1,data=df1 %>% filter(esr1.pos))
lm2 <- lm(ERS ~ ESR1,data=df1 %>% filter(!esr1.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=.8,y=-6,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),esr.pos=TRUE)
txt2 <- data.frame(x=-2,y=2,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),esr.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ESR1",x2="ERS",draw.th=TRUE,x.th="ESR1",split.lm=TRUE) +
  geom_text(data=txt,aes(x=x,y=y,label=label),size=5,color=1)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_esr1_vs_ers_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```
#### between ERS and immune modules

```{r}
lm1 <- lm(TNFa.NFkB ~ ERS,data=df1 %>% filter(ers.pos))
lm2 <- lm(TNFa.NFkB ~ ERS,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=5,y=15,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=-10,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ERS",x2="TNFa.NFkB",draw.th=TRUE,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_ers_vs_apmtc1_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```

```{r}
lm1 <- lm(IFN.I ~ ERS,data=df1 %>% filter(ers.pos))
lm2 <- lm(IFN.I ~ ERS,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=5,y=15,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=-10,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ERS",x2="IFN.I",draw.th=TRUE,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_ers_vs_apmtc2_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```

```{r}
lm1 <- lm(APM.TC ~ ERS,data=df1 %>% filter(ers.pos))
lm2 <- lm(APM.TC ~ ERS,data=df1 %>% filter(!ers.pos))
p.val1 <- paste0("p=",signif(summary(lm1)$coefficients[2,4],3))
r.sq1 <- paste0("Adj.R^2=",signif(summary(lm1)$adj.r.squared,3))
p.val2 <- paste0("p=",signif(summary(lm2)$coefficients[2,4],3))
r.sq2 <- paste0("Adj.R^2=",signif(summary(lm2)$adj.r.squared,3))

txt1 <- data.frame(x=5,y=15,label=paste0("ERS-high:\n",p.val1,"\n",r.sq1),ers.pos=TRUE)
txt2 <- data.frame(x=-10,y=-10,label=paste0("ERS-low:\n",p.val2,"\n",r.sq2),ers.pos=FALSE)
txt <- rbind(txt1,txt2)

p <- my_plot_d3(data=df1,x1="ERS",x2="APM.TC",draw.th=TRUE,x.th="ERS",split.lm=TRUE)+
  geom_text(data=txt,aes(x=x,y=y,label=label,color=ers.pos),size=5)

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_ers_vs_apmtc3_v2.pdf"),width=7,height=7)
print(p)
dev.off()
```

#### discard
```{r}
pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_violin_ers.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="ERS")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_violin_apmtc1.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="TNFa/NFkB")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_violin_apmtc2.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="IFN-I")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_violin_apmtc3.pdf"),width=4,height=8)
my_plot_d1(data=df1,x1="APM/TC")
dev.off()
```


```{r}
pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_esr1_vs_ers.pdf"),width=7,height=7)
my_plot_d2(data=df1,x1="ESR1",x2="ERS")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_ers_vs_apmtc1.pdf"),width=7,height=7)
my_plot_d2(data=df1,x1="ERS",x2="TNFa/NFkB")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_ers_vs_apmtc2.pdf"),width=7,height=7)
my_plot_d2(data=df1,x1="ERS",x2="IFN-I")
dev.off()

pdf(file.path(fig_dir,"6_heatmap_bc_subtypes","activity_plot","meta_ers_vs_apmtc3.pdf"),width=7,height=7)
my_plot_d2(data=df1,x1="ERS",x2="APM/TC")
dev.off()
```



