---
title: "3. Prepare METABRIC data"
output: html_notebook
---

## Initial setup

### Load library
```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(mclust)
  library(limma)
  library(parallel)
})
```

### Set paths
```{r}
proj_dir="~/Dropbox (HMS)/_projects_/B06 03 HR-APM/"

fig_dir <- file.path(proj_dir,"manuscript","figs")
obj_dir <- file.path(proj_dir,"manuscript","RData")

data_dir <- file.path(proj_dir,"data")
metabric_dir <- file.path(data_dir,"brca_metabric")
```

### Gene list
```{r}
x <- load(file=file.path(obj_dir,"1-4_prep","gene_signature.rda")) # gene.sig,category,hallmarks
```

## Load expresssion data (downloaded form cBioPortal)
```{r}
## expression matrix
fns <-   file.path(metabric_dir,
                   c("data_expression_median.txt",
                  	 "data_mRNA_median_Zscores.txt",
                     "data_mRNA_median_all_sample_Zscores.txt"))

meta.mat1 <- read.table(fns[1],sep="\t",header=T,stringsAsFactors=F)
meta.mat2 <- read.table(fns[2],sep="\t",header=T,stringsAsFactors=F)
meta.mat3 <- read.table(fns[3],sep="\t",header=T,stringsAsFactors=F)

meta.mat1[1:5,1:5]
```

### Check column names
Column names of the three matrices are identical.
```{r}
identical(colnames(meta.mat1),colnames(meta.mat2)) # true
identical(colnames(meta.mat1),colnames(meta.mat3)) # true
```

## Pre-processing data
### Compare three expression matrices
```{r}
## colnames - identical
meta.m1 <- as.matrix(meta.mat1[,-(1:2)])
rownames(meta.m1) <- meta.mat1$Hugo_Symbol ## genes whose expression is measured

meta.m2 <- as.matrix(meta.mat2[,-(1:2)])
rownames(meta.m2) <- meta.mat2$Hugo_Symbol ## genes whose expression is measured

meta.m3 <- as.matrix(meta.mat3[,-(1:2)])
rownames(meta.m3) <- meta.mat3$Hugo_Symbol ## genes whose expression is measured

dim(meta.m1) # 24368 genes, 1904 samples
dim(meta.m2) # 18543 genes, 1904 samples
dim(meta.m3) # 24368 genes, 1904 samples
```

### mat1 and mat3 have identical gene sets.
```{r}
identical(meta.mat1$Hugo_Symbol,meta.mat3$Hugo_Symbol) # true
```

### colnames are unique
```{r}
table(table(colnames(meta.m3)))
```


#### Consistency between 3 batches
```{r}
if(0){
  syms12 <- intersect(meta.mat1$Hugo_Symbol,meta.mat2$Hugo_Symbol)
  i=4
  pdf(file.path(fig_dir,"3_prep_metabric","mat1vs2.pdf"),width=7,height=7)
  plot(meta.m1[match(syms12[i],meta.mat1$Hugo_Symbol),],
  	meta.m2[match(syms12[i],meta.mat2$Hugo_Symbol),],
  	main=syms12[i],
  	xlab="M1",ylab="M2",	
  	pch=20)
  dev.off()

  pdf(file.path(fig_dir,"3_prep_metabric","mat1vs3.pdf"),width=7,height=7)
  plot(meta.m1[match(syms12[i],meta.mat1$Hugo_Symbol),],
  	meta.m3[match(syms12[i],meta.mat3$Hugo_Symbol),],
  	main=syms12[i],
  	xlab="M1",ylab="M3",
  	pch=20)
  dev.off()

  pdf(file.path(fig_dir,"3_prep_metabric","mat2vs3.pdf"),width=7,height=7)
  plot(meta.m2[match(syms12[i],meta.mat2$Hugo_Symbol),],
    meta.m3[match(syms12[i],meta.mat3$Hugo_Symbol),],     
  	main=syms12[i],	
  	xlab="M2",ylab="M3",	
  	pch=20)
  dev.off()
}
## they are monotonously increasing relationships, so doesn't matter which samples to use.
```




## Load Clinical data
```{r}
meta.clinical <- read.table(file.path(metabric_dir,"data_clinical_patient.txt"),sep="\t",header=T)
table(meta.clinical$ER_IHC) ## 1817 POSITIVE, 609 NEGATIVE

meta.clinical2 <- read.table(file.path(metabric_dir,"data_clinical_sample.txt"),sep="\t",header=T)
table(meta.clinical2$ER_STATUS) ## 1825 - not used this one

## join the two clinical info
meta.clinical <- meta.clinical %>% left_join(meta.clinical2,by="PATIENT_ID")

meta.clinical$PATIENT_ID <- gsub("-",".",meta.clinical$PATIENT_ID)

##
used.ids <- colnames(meta.m3)
table(used.ids %in% meta.clinical$PATIENT_ID) ## all samples' records exist in clinical metadata

meta.clinical <- meta.clinical %>% filter(PATIENT_ID %in% used.ids)

```
### Disease status
```{r}
meta.clin.1 <- meta.clinical %>%
	filter(ER_STATUS %in% c("Positive","Negative")) %>%
	filter(PR_STATUS %in% c("Positive","Negative")) %>%
	filter(HER2_STATUS %in% c("Positive","Negative"))

##
pdf(file.path(fig_dir,"3_prep_metabric","metabric_brca_subtypes.pdf"),width=7,height=7)
vennDiagram(cbind(
	`ER+`=(meta.clinical$ER_STATUS=="Positive"),
	`PR+`=(meta.clinical$PR_STATUS=="Positive"),
	`HER2+`=(meta.clinical$HER2_STATUS=="Positive")),
main="METABRIC samples")
dev.off()

vennDiagram(cbind(
	`ER+`=(meta.clinical$ER_STATUS=="Positive"),
	`PR+`=(meta.clinical$PR_STATUS=="Positive"),
	`HER2+`=(meta.clinical$HER2_STATUS=="Positive")),
main="METABRIC samples")
```

### Patient IDs per subtype
```{r}
if(1){
  meta.er.pos.ids <- (meta.clin.1 %>% 
  	filter(
  		(ER_STATUS == "Positive" | 
  		PR_STATUS == "Positive")
  			& HER2_STATUS == "Negative"))$PATIENT_ID # 445
  
  meta.her2.pos.ids <- (meta.clin.1 %>% 
  	filter(ER_STATUS == "Negative" & 
  		PR_STATUS == "Negative" &
  		HER2_STATUS == "Positive"))$PATIENT_ID # 37
  
  meta.dp.ids <- (meta.clin.1 %>% 
  	filter((ER_STATUS == "Positive" | 
  		PR_STATUS == "Positive")
  			& HER2_STATUS == "Positive"))$PATIENT_ID # 126
  
  meta.tnbc.ids <- (meta.clin.1 %>% 
  	filter(ER_STATUS == "Negative" & 
  		PR_STATUS == "Negative" &
  		HER2_STATUS == "Negative"))$PATIENT_ID # 37
  
  meta.ids <- list(
  	hr=meta.er.pos.ids,
  	her2=meta.her2.pos.ids,
  	dp=meta.dp.ids,
  	tnbc=meta.tnbc.ids
  )
}else{
  meta.er.pos.ids <- (meta.clin.1 %>% 
  	filter(ER_STATUS == "Positive" & HER2_STATUS == "Negative"))$PATIENT_ID # 445
  
  meta.her2.pos.ids <- (meta.clin.1 %>% 
  	filter(ER_STATUS == "Negative" & HER2_STATUS == "Positive"))$PATIENT_ID # 37
  
  meta.dp.ids <- (meta.clin.1 %>% 
  	filter(ER_STATUS == "Positive" & HER2_STATUS == "Positive"))$PATIENT_ID # 126
  
  meta.dn.ids <- (meta.clin.1 %>% 
  	filter(ER_STATUS == "Negative" & HER2_STATUS == "Negative"))$PATIENT_ID # 37
  
  meta.ids <- list(
  	hr=meta.er.pos.ids,
  	dp=meta.dp.ids,
  	her2=meta.her2.pos.ids,
  	dn=meta.dn.ids)
}
sapply(meta.ids,length) 
```

<!-- ### Remove non-measured and impute them -->
<!-- ```{r} -->
<!-- if(0){ -->
<!--   ## m2: normalize using mean and sd of all samples, all txns -->
<!--   m2 <- mean(meta.m2,na.rm=T) ## much closer to zero -->
<!--   sd.m2 <- sd(meta.m2,na.rm=T) ## much closer to 1 -->

<!--   ## m3: normalize using mean and sd of all sapmles, per gene -->
<!--   rownames(meta.m3) <- meta.syms -->
<!--   mean.m3 <- rowMeans(meta.m3,na.rm=T) -->
<!--   sd.m3 <- apply(meta.m3,1,sd,na.rm=T) -->
<!--   hist(mean.m3,breaks=1000) -->
<!--   hist(sd.m3,breaks=1000) -->
<!-- } -->
<!-- ``` -->

## Redundant genes are removed - use only the most abundantly expressed ones

```{r}
user.ids <- unlist(meta.ids)
dim(meta.clinical)
length(unlist(meta.ids))
all(user.ids %in% meta.clinical$PATIENT_ID)

##
rm1 <- rowMeans(meta.m1,na.rm=T)
uniq.syms1 <- sort(unique(names(rm1))) # 24368 -> 24176
idx1 <- tapply(seq(rm1),names(rm1),function(i){
  this.means <- rm1[i]
  j <- which(this.means==max(this.means))
  return(i[j])
},simplify=TRUE)

mm1 <- meta.m1[idx1,user.ids]
rownames(mm1) <- uniq.syms1

##
rm2 <- rowMeans(meta.m2,na.rm=T)
uniq.syms2 <- sort(unique(names(rm2))) # 18543 -> 17296
idx2 <- tapply(seq(rm2),names(rm2),function(i){
  this.means <- rm2[i]
  j <- which(this.means==max(this.means))
  return(i[j])
},simplify=TRUE)
idx2 <- do.call(c,idx2[sapply(idx2,length)==1])
uniq.syms2 <- names(idx2)
mm2 <- meta.m2[idx2,user.ids]
rownames(mm2) <- uniq.syms2

##
mm3 <- meta.m3[idx1,user.ids]
rownames(mm3) <- uniq.syms1  # 24368 -> 24176
```

## Remove artifacts
### Define threshold for expression: `exp.th`
```{r}
med.m1 <- apply(mm1,1,mean,na.rm=T)
x <- hist(mm1,breaks=1000)
mean.x <- x$mids[which(x$counts==max(x$counts))]
abline(v=mean.x,col=2)
negs <- mm1[mm1 < mean.x] - mean.x
negs <- negs[!is.na(negs)]
sd.x <- sqrt(sum(negs^2)/length(negs))
xs <- x$mids
ds <- dnorm(xs,mean=mean.x,sd=sd.x)
f <- max(x$counts)/max(ds)
ds <- ds*f
lines(xs,ds,col=3)

## m1: log-transformed, not z-score
p.thres <- 1-10^-3
exp.th <- qnorm(p.thres,mean=mean.x,sd=sd.x)
abline(v=exp.th,col=2)

if(0){
  pdf(file.path(fig_dir,"3_prep_metabric","prep_hlaa_exp1.pdf"),width=7,height=7)
  par(mfrow=c(3,1))
  rng <- range(mm1[,],na.rm=T)
  x <- hist(mm1[,],breaks=1000,xlim=rng,border=NA,col="grey60",
       main="METABRIC: Expression of all genes",
       xlab="Expression (log2)")
  abline(v=mean.x)
  lines(xs,ds,col="steelblue",lwd=2)
  abline(v=exp.th,col=2)
  hist(mm1["HLA-A",],breaks=x$breaks,xlim=rng,border=NA,col="grey60",
       main="METABRIC: Expression of HLA-A",
       xlab="Expression (log2)")
  abline(v=exp.th,col=2)
  hist(mm1["HLA-C",],breaks=x$breaks,xlim=rng,border=NA,col="grey60",
      main="METABRIC: Expression of HLA-C",
      xlab="Expression (log2)")
  abline(v=exp.th,col=2)
  dev.off()
}
```

### Impute 10 NAs in mm1 with bg value (mean.x)
```{r}
## 10 NAs originally - supply mean.x
which(is.na(mm1),arr.ind=T) # 10 of them
table(colSums(is.na(mm1)))
mm1[is.na(mm1)] <- mean.x
```

```{r}
has.0 <- apply(mm1,1,function(xx)sum(xx < exp.th))
med.0 <- apply(mm1,1,function(xx)median(xx))

plot(has.0,med.0,
     xlab="# of samples whose expression is < exp.th (per gene)",
     ylab="median expression (per gene)",
     pch=20,col="grey70"
     )
abline(h=exp.th,col=2)
```

### Identify genes lacking expression artificially
```{r}
mm1[is.na(mm1)] <- mean.x
system.time({
  lst <- parallel::mclapply(uniq.syms1,function(sym){
    i <- match(sym,uniq.syms1)
    if(i %% 1000 == 0){
      cat("*")
    }
    this <- mm1[sym,]
    
    ## model selection
    set.seed(1)
    bic <- mclustBIC(this,G=1:2,modelNames="V",verbose=FALSE)
    g <- which.max(bic)
    mc <- Mclust(this,G=g,modelNames="V",verbose=FALSE)
    mns <- mc$parameters$mean
      
    if(g==1){
      peaks <- c(mns,NA)
      is.between <- NA
    }else if(g==2){
      peaks <- sort(mns)
      i <- which.min(mns)
      max.min <- max(this[mc$classification==1])
      is.between <- max.min > min(mns) && max.min < max(mns)
    }
    
    is.bg <- min(mns) < exp.th
    max.sig <- max(mns) > exp.th
    
    return(c(sym=sym,
             g=g,
             is.bg=is.bg,
             sig=max.sig,
             p1=peaks[1],
             p2=peaks[2],
             is.between=is.between
             ))
  },mc.cores=15)
  saveRDS(lst,file=file.path(obj_dir,"1-4_prep","metabric_model_selection.rds"))
})
#     user   system  elapsed 
# 1293.702   23.581   91.916 

lst1 <- as.data.frame(do.call(rbind,lst)) %>%
  rename(p1="p1.1",p2="p2.2") %>%
  mutate(is.bg=as.logical(is.bg),
    sig=as.logical(sig),
    is.between=as.logical(is.between),
    p1=as.numeric(p1),
    p2=as.numeric(p2))

df <- cbind(lst1,
            median=med.0,
            n.smpls.bg=has.0
            ) %>% mutate(d=p2-p1)

df$is.between[is.na(df$is.between)] <- FALSE

## visual checking - if wanted
n.smpls <- ncol(mm1)
pts <- colnames(mm1)
sta <- rep(NA,length(pts))
names(sta) <- pts

sta[pts %in% meta.ids$hr] <- "hr"
sta[pts %in% meta.ids$her2] <- "her2"
sta[pts %in% meta.ids$dp] <- "dp"
sta[pts %in% meta.ids$tnbc] <- "tnbc"
sta <- factor(sta,levels=c("hr","dp","her2","tnbc"))

## ANOVA - shouldn't be split by the subtypes
syms <- df$sym
p.vals <- sapply(syms,function(sym){
  df <- data.frame(exp=mm1[sym,],group=sta)
  res.aov <- aov(exp ~ group, data=df)
  p.value <- summary(res.aov)[[1]][[5]][1]
  return(p.value)
})

df1 <- df %>% 
  mutate(p.val = p.vals) %>%
  filter(!is.na(p2)) ## 24176 -> 18882 genes

sig.df <- df1 %>% 
  filter(is.between == TRUE) %>%
  filter(g==2 & is.bg==1 & sig) %>%
  filter(median > exp.th) %>%
  filter(p.val > 1e-20) %>%
  filter(n.smpls.bg < n.smpls * .25) %>%
  arrange(desc(d)) # 52

if(0){
  boxplot(mm1["ESR1",] ~ sta,breaks=1000) # above thres
  boxplot(mm1["SCAMP1",] ~ sta,breaks=1000) # above thres
  abline(h=exp.th,col=2)

  boxplot(mm1["AR",user.ids] ~ sta,las=2)

  ## thres for # bg samples
  xx <- hist(df$n.smpls.bg,breaks=100)
  abline(v=n.smpls * .25,col=2)

  hist(sig.df$d,breaks=100)
  hist(mm1["ESR1",])
  hist(mm1["ANKRD30A",],breaks=1000)
  hist(mm1["AGR3",],breaks=1000)
  hist(mm1["GPT",],breaks=1000)
}
```
 
### Make the low values `NA`

```{r}
mm1 <- meta.m1
mm3 <- meta.m3
mm1.0 <- mm1
mm3.0 <- mm3
mm1.1 <- mm1[sig.df$sym,]
mm3.1 <- mm3[sig.df$sym,]

mm1.1[mm1[sig.df$sym,] < exp.th] <- NA
mm3.1[mm1[sig.df$sym,] < exp.th] <- NA
sum(is.na(mm1.1)) # 6437
sum(is.na(mm3.1)) # 6437

mm1.0[sig.df$sym,] <- mm1.1
mm3.0[sig.df$sym,] <- mm3.1

meta.m1 <- mm1.0
meta.m3 <- mm3.0

range(rowSums(is.na(mm3.0))) # 0-465
range(colSums(is.na(mm3.0))) # 0-13

  ## we should use mm3 (zscore)
meta.m3i <- mm3.2 <- impute::impute.knn(mm3.0,k=10)[[1]]

if(0){
  was.na <- is.na(mm3.1["HLA-A",])
  plot(mm3.2["CD8A",],mm3.2["HLA-A",],col=was.na+1)
  cor(mm3.2["CD8A",],mm3.2["HLA-A",],method="spearman")
  cor(mm3.2["CD8A",!was.na],mm3.2["HLA-A",!was.na],method="spearman")
  cor(mm3.2["CD8A",was.na],mm3.2["HLA-A",was.na],method="spearman")
  
  plot(mm3.2["ESR1",],mm3.2["HLA-A",],col=was.na+1)
  cor(mm3.2["ESR1",],mm3.2["HLA-A",],method="spearman")
  cor(mm3.2["ESR1",!was.na],mm3.2["HLA-A",!was.na],method="spearman")
  cor(mm3.2["ESR1",was.na],mm3.2["HLA-A",was.na],method="spearman")
}
  
if(0){
  mm1.2 <- impute.knn(mm1.0,k=10)
  was.na <- is.na(mm1.1["HLA-A",])
  plot(mm1.2["CD8A",],mm1.2["HLA-A",],col=was.na+1)
  cor(mm1.2["CD8A",],mm1.2["HLA-A",],method="spearman")
  cor(mm1.2["CD8A",!was.na],mm1.2["HLA-A",!was.na],method="spearman")
  cor(mm1.2["CD8A",was.na],mm1.2["HLA-A",was.na],method="spearman")
  
  cor(mm1.2["ESR1",],mm1.2["HLA-A",],method="spearman")
  cor(mm1.2["ESR1",!was.na],mm1.2["HLA-A",!was.na],method="spearman")
  cor(mm1.2["ESR1",was.na],mm1.2["HLA-A",was.na],method="spearman")
}

```
 


## Save data in rda
```{r}
meta.syms <- uniq.syms1
meta.exp.th <- exp.th
meta.df <- df
meta.sig.df <- sig.df # 20 genes

# dim(meta.m1)
# dim(meta.m3)
# dim(meta.clinical)
# length(unlist(meta.ids))

save(meta.ids,meta.clinical,meta.syms,meta.m1,meta.m3,meta.m3i,
     meta.exp.th,meta.df,meta.sig.df,
     file=file.path(obj_dir,"1-4_prep","metabric_processed_v3.rda"))
```
