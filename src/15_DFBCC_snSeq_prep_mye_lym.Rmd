---
title: "Lymph and Macrophage Cell Type Analysis"
author: "Kenichi Shimada"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Initial setup

### Load libraries
```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(caret)
})
```

### Load input data
```{r}
obj_dir1 <- file.path(obj_dir,"15_dfbcc_snseq")
fig_dir1 <- file.path(fig_dir,"15_dfbcc_snseq","v3")

x3 <- load(file.path(obj_dir1,"seurat_harmony_sct_lymph_cleanv1_4.RData"))
x5 <- load(file.path(obj_dir1,"seurat_sct_sct_macv2_4.RData"))
```

### Visualize cell types in `seurat_lymph_clean`
```{r}
# DimPlot(seurat_lymph_clean, group.by = "celltype_broad", label=FALSE, reduction = "umap", raster=FALSE) +
#   ggplot2::ggtitle("seurat_lymph_clean (celltype_broad)")
```

```{r}
FeaturePlot(seurat_lymph_clean, feature = "PDCD1", label=FALSE, reduction = "umap", raster=FALSE)
FeaturePlot(seurat_lymph_clean, feature = "CD3E", label=FALSE, reduction = "umap", raster=FALSE)
FeaturePlot(seurat_lymph_clean, feature = "CD4", label=FALSE, reduction = "umap", raster=FALSE)
FeaturePlot(seurat_lymph_clean, feature = "CD8A", label=FALSE, reduction = "umap", raster=FALSE)
FeaturePlot(seurat_lymph_clean, feature = "FOXP3", label=FALSE, reduction = "umap", raster=FALSE)
```

## Subsetting `seurat_lymph_clean` to T cells
```{r}
set.seed(123)
lym.cts <- seurat_lymph_clean$celltype_broad
seurat_T <- subset(seurat_lymph_clean, cells=names(lym.cts[!lym.cts %in% c("NK_cell","Regulatory_T","B_cell","Plasma_cell")]))

seurat_T <- SCTransform(seurat_T, method = "glmGamPoi", vars.to.regress = "mitoRatio", verbose = TRUE, variable.features.n = 3000)
seurat_T <- RunPCA(seurat_T, assay = "SCT", npcs = 100, verbose = TRUE)

data.matrix <- GetAssayData(seurat_T, assay = "SCT", layer ="scale.data") 
raw.matrix <- GetAssayData(seurat_T, assay = "RNA", layer ="data")

# Elbow Plot for Variance Explained by PCAs
pdf("Elbowplot_sct_sct_macv2_clean.pdf")
ElbowPlot(seurat_T, ndims = 100)
dev.off()
```

### Running UMAP without harmony
```{r}
use.pcs <- 1:30
seurat_T <- RunUMAP(seurat_T, reduction = "pca", assay = "SCT", dims = use.pcs, verbose = TRUE)
seurat_T <- FindNeighbors(object = seurat_T, reduction = "pca", dims = use.pcs, assay = "SCT")
seurat_T <- FindClusters(object = seurat_T, resolution = seq(0.1, 1, 0.1))
```

### customSummary
```{r}
# Print the model summary
customSummary <- function(data, lev = NULL, model = NULL) {
  sensitivity <- sensitivity(data$obs, data$pred, lev[1])
  out <- c(Sensitivity = sensitivity)
  names(out) <- c("Sensitivity")
  out
}

```

### Build CD4 and CD8 classifiers
```{r}
cd4.pos <- raw.matrix["CD4", ] > 0
cd8.pos <- colSums(raw.matrix[grep("^CD8[AB]", rownames(raw.matrix)), ]) > 0

# Define Elastic Net Model for CD4
x <- Embeddings(seurat_T, "pca")[, 1:30]
y_cd4 <- factor(cd4.pos, levels=c("TRUE", "FALSE"))
x_cd4 <- data.frame(cbind(y_cd4, x))
x_cd4$y_cd4 <- factor(x_cd4$y_cd4, labels=c("X_TRUE", "X_FALSE"))

set.seed(123)
y.cd4.true <- which(x_cd4$y_cd4 == "X_TRUE")
y.cd4.false <- sample(which(x_cd4$y_cd4 == "X_FALSE"), length(y.cd4.true))
x.sub.cd4 <- x_cd4[c(y.cd4.true, y.cd4.false), ]

# Define Control Method for Cross-Validation
train_control <- trainControl(method = "cv", number = 5, classProbs = TRUE, summaryFunction = customSummary)

# Train CD4 Model
model4 <- train(y_cd4 ~ ., data=x.sub.cd4, method = "glm", family = "binomial", trControl = train_control, metric = "Sensitivity")

# Train CD8 Model
y_cd8 <- factor(cd8.pos, levels=c("TRUE", "FALSE"))
x_cd8 <- data.frame(cbind(y_cd8, x))
x_cd8$y_cd8 <- factor(x_cd8$y_cd8, labels=c("X_TRUE", "X_FALSE"))

y.cd8.true <- which(x_cd8$y_cd8 == "X_TRUE")
y.cd8.false <- sample(which(x_cd8$y_cd8 == "X_FALSE"), length(y.cd8.true))
x.sub.cd8 <- x_cd8[c(y.cd8.true, y.cd8.false), ]

model8 <- train(y_cd8 ~ ., data=x.sub.cd8, method = "glm", family = "binomial", trControl = train_control, metric = "Sensitivity")
```

```{r}
pred.cd4 <- predict(model4,newdata=x_cd4[-1])
pred.cd8 <- predict(model8,newdata=x_cd8[-1])

pred.cd48 <- factor((2-as.numeric(pred.cd4)) + (2-as.numeric(pred.cd8) *2) + 1,labels=c("DN","CD4","CD8","DP"))

seurat_T@meta.data$pred.cd4 <- pred.cd4
seurat_T@meta.data$pred.cd8 <- pred.cd8
seurat_T@meta.data$pred.cd48 <- pred.cd48

seurat_T@meta.data$ori.cd4 <- factor(raw.matrix["CD4",]>0,levels=c("TRUE","FALSE"))
seurat_T@meta.data$ori.cd8 <- factor(colSums(raw.matrix[c("CD8A","CD8B","CD8B2"),])>0,levels=c("TRUE","FALSE"))
```


```{r}
FeaturePlot(seurat_T, feature = "CD4", label=FALSE, reduction = "umap",raster=FALSE) +
  ggplot2::ggtitle("CD4 (raw expression)")
FeaturePlot(seurat_T, feature = "CD8A", label=FALSE, reduction = "umap",raster=FALSE) +
  ggplot2::ggtitle("CD8A (raw expression)")  
DimPlot(seurat_T, group.by = "pred.cd4", label=FALSE, reduction = "umap",raster=FALSE) +
  ggplot2::ggtitle("CD4 (prediction with glm)")  
DimPlot(seurat_T, group.by = "pred.cd8", label=FALSE, reduction = "umap",raster=FALSE) +
  ggplot2::ggtitle("CD8 (prediction with glm)")  

DimPlot(seurat_T, group.by = "pred.cd48", label=FALSE, reduction = "umap",raster=FALSE) +
  ggplot2::ggtitle("CD4 and CD8 positivity (prediction with glm)")  

DimPlot(seurat_T, group.by = "ori.cd4", label=FALSE, reduction = "umap",raster=FALSE) 
DimPlot(seurat_T, group.by = "ori.cd8", label=FALSE, reduction = "umap",raster=FALSE) 

table(obs.cd4=seurat_T$ori.cd4,obs.cd8=seurat_T$ori.cd8)
table(pred.cd4=seurat_T$pred.cd4,pred.cd8=seurat_T$pred.cd8)

table(truth=x_cd4$y_cd4,prediction=pred.cd4)
```


```{r}
## CD4+ vs CD8+
idx.cd4 <- which(y_cd4=="TRUE" & y_cd8=="FALSE") # 245
idx.cd8 <- which(y_cd4=="FALSE" & y_cd8=="TRUE") # 563

set.seed(123)
idx.cd8.sub <- sample(idx.cd8,length(idx.cd4))
idx <- c(idx.cd4,idx.cd8.sub)

y_cd48 <- rep("",nrow(x))
y_cd48[idx.cd4] <- "CD4"
y_cd48[idx.cd8] <- "CD8"
y_cd48 <- factor(y_cd48,levels=c("CD4","CD8"))

x_cd48 <- data.frame(cbind(y_cd48,x))
x_cd48$y_cd48 <- factor(x_cd48$y_cd48,labels=c("CD4","CD8"))

x.sub.cd48 <- x_cd48[idx,]

train_control <- trainControl(method = "cv", 
                              number = 5, 
                              classProbs = TRUE , 
                              summaryFunction = twoClassSummary)
model48 <- train(y_cd48 ~ ., 
                 data=x.sub.cd48, 
                 method = "glm", 
                 family = "binomial", 
                 trControl = train_control, 
                 metric = "ROC")

pred.cd48 <- predict(model48,newdata=x_cd48[-1])
seurat_T@meta.data$pred.cd4.cd8.roc <- pred.cd48

DimPlot(seurat_T, group.by = "pred.cd4.cd8.roc", label=FALSE, reduction = "umap",raster=FALSE) +
  ggplot2::ggtitle("classification (ROC); CD4 or CD8 (prediction with glm)")  

# train_control <- trainControl(method = "cv", 
#                               number = 5, 
#                               classProbs = TRUE , 
#                               summaryFunction = customSummary)
# 
# model48 <- train(y_cd48 ~ ., 
#                  data=x.sub.cd48, 
#                  method = "glm", 
#                  family = "binomial", 
#                  trControl = train_control, 
#                  metric = "Sensitivity")
# 
# pred.cd48 <- predict(model48,newdata=x_cd48[-1])
# 
# seurat_T@meta.data$pred.cd4.cd8.sens <- pred.cd48
# DimPlot(seurat_T, group.by = "pred.cd4.cd8.sens", label=FALSE, reduction = "umap",raster=FALSE) +
#   ggplot2::ggtitle("classification (SENS) - CD4 or CD8 (prediction with glm)")  

##
DimPlot(seurat_T, group.by = "ori.cd4", label=FALSE, reduction = "umap",raster=FALSE) 
DimPlot(seurat_T, group.by = "ori.cd8", label=FALSE, reduction = "umap",raster=FALSE) 

table(obs.cd4=seurat_T$ori.cd4,obs.cd8=seurat_T$ori.cd8)
table(pred.cd4=seurat_T$pred.cd4,pred.cd8=seurat_T$pred.cd8)

##
seurat_T$celltype_broad <- paste0(as.character(seurat_T$pred.cd4.cd8.roc),"_T")
seurat_lymph_clean$celltype_broad[names(seurat_T$celltype_broad)] <- seurat_T$celltype_broad
```



### Visualizing classifier predictions
```{r}
DimPlot(seurat_lymph_clean, group.by = "celltype_broad", label=FALSE, reduction = "umap",raster=FALSE)  +
  ggplot2::ggtitle("seurat_lymph_clean (celltype_broad_updated)")
```

```{r}
DimPlot(seurat_T, group.by = "pred.CD4", reduction = "umap", label=FALSE, raster=FALSE) + ggplot2::ggtitle("CD4 Prediction")
DimPlot(seurat_T, group.by = "pred.CD8", reduction = "umap", label=FALSE, raster=FALSE) + ggplot2::ggtitle("CD8 Prediction")
DimPlot(seurat_T, group.by = "pred.CD4_8", reduction = "umap", label=FALSE, raster=FALSE) + ggplot2::ggtitle("CD4/CD8 Prediction")
VlnPlot(seurat_T,group.by = "pred.CD4_8", features="HLA-A")
```

### Save processed data
```{r}
save(seurat_lymph_clean, file=file.path(obj_dir1, "seurat_harmony_sct_lymph_clean_KS.RData"))
```

## Subsetting `seurat_mac` to macrophage subtypes

### Macrophage cell types in seurat_mac
```{r}
mac_gns <- c("CD68", "CD163", "CD14", "LYZ", "FCGR3A")
DimPlot(seurat_mac, group.by = "celltype_broad", label=FALSE, reduction = "umap", raster=FALSE) + ggplot2::ggtitle("seurat_mac (celltype_broad)")
```

```{r}
set.seed(123)
mac.cts <- seurat_mac$celltype_broad
seurat_M <- subset(seurat_mac, cells=names(mac.cts[!mac.cts %in% c("Undetermined", "CTSK_TAM")]))
seurat_M <- SCTransform(seurat_M, method = "glmGamPoi", vars.to.regress = "mitoRatio", verbose = TRUE, variable.features.n = 3000)
seurat_M <- RunPCA(seurat_M, assay = "SCT", npcs = 100, verbose = TRUE)

data.matrix <- GetAssayData(seurat_M, assay = "SCT", layer ="scale.data")
raw.matrix <- GetAssayData(seurat_M, assay = "RNA", layer ="data")

# Elbow Plot for PCA Variance
pdf("Elbowplot_sct_sct_macv2_clean.pdf")
ElbowPlot(seurat_M, ndims = 100)
dev.off()

# UMAP without Harmony
use.pcs <- 1:30
seurat_M <- RunUMAP(seurat_M, reduction = "pca", assay = "SCT", dims = use.pcs, verbose = TRUE)
seurat_M <- FindNeighbors(object = seurat_M, reduction = "pca", dims = use.pcs, assay = "SCT")
seurat_M <- FindClusters(object = seurat_M, resolution = seq(0.1, 1, 0.1))
```

### Building CD68 and CD163 classifiers
```{r}
CD68.pos <- raw.matrix["CD68", ] > 0
CD163.pos <- raw.matrix["CD163", ] > 0

# Define Elastic Net Model
x <- Embeddings(seurat_M, "pca")[, 1:30]
y_CD68 <- factor(CD68.pos, levels=c("TRUE", "FALSE"))
y_CD163 <- factor(CD163.pos, levels=c("TRUE", "FALSE"))

x_CD68 <- data.frame(cbind(y_CD68, x))
x_CD68$y_CD68 <- factor(x_CD68$y_CD68, labels=c("X_TRUE", "X_FALSE"))
x_CD163 <- data.frame(cbind(y_CD163, x))
x_CD163$y_CD163 <- factor(x_CD163$y_CD163, labels=c("X_TRUE", "X_FALSE"))

# Balance the data
set.seed(123)
y.CD68.true <- which(x_CD68$y_CD68 == "X_TRUE")
y.CD68.false <- sample(which(x_CD68$y_CD68 == "X_FALSE"), length(y.CD68.true))
x.sub.CD68 <- x_CD68[c(y.CD68.true, y.CD68.false), ]

y.CD163.true <- which(x_CD163$y_CD163 == "X_TRUE")
y.CD163.false <- sample(which(x_CD163$y_CD163 == "X_FALSE"), length(y.CD163.true))
x.sub.CD163 <- x_CD163[c(y.CD163.true, y.CD163.false), ]

# Define Control for Cross-Validation
train_control <- trainControl(method = "cv", number = 5, classProbs = TRUE, summaryFunction = customSummary)

# Train Models for CD68 and CD163
model68 <- train(y_CD68 ~ ., data=x.sub.CD68, method = "glm", family = "binomial", trControl = train_control, metric = "ROC")
model163 <- train(y_CD163 ~ ., data=x.sub.CD163, method = "glm", family = "binomial", trControl = train_control, metric = "ROC")
```

```{r}
# Predictions for CD68 and CD163
pred.CD68 <- predict(model68, newdata=x_CD68[-1])
pred.CD163 <- predict(model163, newdata=x_CD163[-1])

# Combined Predictions
pred.CD68_163 <- factor((2 - as.numeric(pred.CD68)) + (2 - as.numeric(pred.CD163) * 2) + 1, labels=c("DN", "CD68", "CD163", "DP"))

# Add Predictions to Metadata
seurat_M@meta.data$pred.CD68 <- pred.CD68
seurat_M@meta.data$pred.CD163 <- pred.CD163
seurat_M@meta.data$pred.CD68_163 <- pred.CD68_163

seurat_M@meta.data$ori.CD68 <- factor(raw.matrix["CD68",]>0,levels=c("TRUE","FALSE"))
seurat_M@meta.data$ori.CD163 <- factor(raw.matrix["CD163",]>0,levels=c("TRUE","FALSE"))
```

### Visualizing predictions for CD68 and D163
```{r}
# Feature Plots for CD68 and CD163
FeaturePlot(seurat_M, feature = "CD68", label=FALSE, reduction = "umap", raster=FALSE) + ggplot2::ggtitle("CD68 (raw expression)")
FeaturePlot(seurat_M, feature = "CD163", label=FALSE, reduction = "umap", raster=FALSE) + ggplot2::ggtitle("CD163 (raw expression)")
DimPlot(seurat_M, group.by = "pred.CD68", label=FALSE, reduction = "umap", raster=FALSE) + ggplot2::ggtitle("CD68 (Prediction with GLM)")
DimPlot(seurat_M, group.by = "pred.CD163", label=FALSE, reduction = "umap", raster=FALSE) + ggplot2::ggtitle("CD163 (Prediction with GLM)")
DimPlot(seurat_M, group.by = "pred.CD68_163", label=FALSE, reduction = "umap", raster=FALSE) + ggplot2::ggtitle("CD68 and CD163 Positivity (Prediction with GLM)")

DimPlot(seurat_M, group.by = "ori.CD68", label=FALSE, reduction = "umap",raster=FALSE) 
DimPlot(seurat_M, group.by = "ori.CD163", label=FALSE, reduction = "umap",raster=FALSE) 

```

```{r}
table(obs.CD68=seurat_M$ori.CD68,obs.CD163=seurat_M$ori.CD163)
table(pred.CD68=seurat_M$pred.CD68,pred.CD163=seurat_M$pred.CD163)

table(truth=x_CD68$y_CD68,prediction=pred.CD68)
table(pred=pred.CD68_163,sample=seurat_M$sample)
```

```{r}
pred.CD68_163 <- paste0("Mac_",pred.CD68_163)
seurat_M$celltype_broad <- factor(pred.CD68_163,levels=c("Mac_DN","Mac_CD68","Mac_CD163","Mac_DP"))

seurat_mac@meta.data$celltype_broad_v2 <- seurat_mac$celltype_broad
seurat_mac$celltype_broad_v2[names(seurat_M$celltype_broad)] <- as.character(seurat_M$celltype_broad)
seurat_mac$celltype_broad_v2[seurat_mac$celltype_broad_v2=="CTSK_TAM"] <- "Mac_CD68"
seurat_mac$celltype_broad_v2 <- factor(seurat_mac$celltype_broad_v2,
                                    levels=c("Mac_DN","Mac_CD68","Mac_CD163","Mac_DP"))
```


```{r}
table(seurat_mac$celltype_broad,seurat_mac$celltype_broad_v2)
DimPlot(seurat_mac, group.by = "celltype_broad_v2", label=FALSE, reduction = "umap",raster=FALSE)  +
  ggplot2::ggtitle("seurat_mac (celltype_broad_updated)")
# idx.dn <- which(as.character(seurat_mac$celltype_broad_v2)!="Mac_DN")
seurat_mac2 <- subset(seurat_mac,cells=names(seurat_mac$celltype_broad_v2)[idx.dn])
DimPlot(seurat_mac2, group.by = "celltype_broad_v2", label=FALSE, reduction = "umap",raster=FALSE)  +
  ggplot2::ggtitle("seurat_mac (celltype_broad_updated; without DN)")
```

```{r}
if(0){
  ## CD68+ vs CD163+
  idx.CD68 <- which(y_CD68=="TRUE" & y_CD163=="FALSE") # 245
  idx.CD163 <- which(y_CD68=="FALSE" & y_CD163=="TRUE") # 563
  
  set.seed(123)
  idx.CD163.sub <- sample(idx.CD163,length(idx.CD68))
  idx <- c(idx.CD68,idx.CD163.sub)
  
  y_CD68_163 <- rep("",nrow(x))
  y_CD68_163[idx.CD68] <- "CD68"
  y_CD68_163[idx.CD163] <- "CD163"
  y_CD68_163 <- factor(y_CD68_163,levels=c("CD68","CD163"))
  
  x_CD68_163 <- data.frame(cbind(y_CD68_163,x))
  x_CD68_163$y_CD68_163 <- factor(x_CD68_163$y_CD68_163,labels=c("CD68","CD163"))
  
  x.sub.CD68_163 <- x_CD68_163[idx,]
  
  ### ROC
  train_control <- trainControl(method = "cv", 
                                number = 5, 
                                classProbs = TRUE , 
                                summaryFunction = twoClassSummary)
  
  model68.163 <- train(y_CD68_163 ~ ., 
                   data=x.sub.CD68_163, 
                   method = "glm", 
                   family = "binomial", 
                   trControl = train_control, 
                   metric = "ROC")
  
  pred.CD68_163.1 <- as.character(predict(model68.163,newdata=x_CD68_163[-1]))
}
```


```{r}
table(obs.CD68=seurat_M$ori.CD68,obs.CD163=seurat_M$ori.CD163)
table(pred.CD68=seurat_M$pred.CD68,pred.CD163=seurat_M$pred.CD163)
```


```{r}
if(0){
  ##
  library(dplyr)
  df.gs <- readRDS("/Users/kenichishimada/Dropbox (HMS)/_projects_/B06 03 HR-APM/manuscript/Rdata/11_dfbcc_txn/df_pcs_mod_activity_v3.rds")
  bots <- (df.gs %>% arrange(desc(ERS)))$bot
  bots <- sub("BOT","",bots)
  bots.used <- intersect(bots,unique(seurat_M$sample))
  
  table(indiv=pred.CD68_163,combined=pred.CD68_163.1)
  
  ### frequency per module activity
  tab4 <- table(mac_subtype=pred.CD68_163,sample=seurat_M$sample)
  sub4 <- array(tab4,dim(tab4))/colSums(tab4)[col(tab4)]
  dimnames(sub4) <- dimnames(tab4)
  par(mar=c(5,5,4,10))
  barplot(sub4[4:1,bots.used],las=2,col=4:1,main="split separately by 68 and 163")
  legend(par()$usr[2],par()$usr[4],rownames(sub4),fill=1:4,xpd=T)
  
  ##
  tab3 <- tab4[2:4,]
  sub3 <- array(tab3,dim(tab3))/colSums(tab3)[col(tab3)]
  dimnames(sub3) <- dimnames(tab3)
  par(mar=c(5,5,4,10))
  barplot(sub3[3:1,bots.used],las=2,col=4:2,main="split separately by 68 and 163 (DN removed)")
  legend(par()$usr[2],par()$usr[4],rownames(sub3),fill=2:4,xpd=T)
  
  ##
  seurat_M@meta.data$pred.CD68.CD163.cmbd <- factor(pred.CD68_163.1,levels=c("CD68","CD163"))
  seurat_M@meta.data$pred.CD68.CD163.cmbd <- factor(pred.CD68_163.1,levels=c("CD68","CD163"))
  
  pred.CD68_163.1 <- as.character(predict(model68.163,newdata=x_CD68_163[-1]))
  
  tab4.1 <- table(mac_subtype=pred.CD68_163.1,sample=seurat_M$sample)
  sub4.1 <- array(tab4.1,dim(tab4.1))/colSums(tab4.1)[col(tab4.1)]
  dimnames(sub4.1) <- dimnames(tab4.1)
  par(mar=c(5,5,4.1,10))
  barplot(sub4.1[1:2,bots.used],las=2,col=3:2,main="split by 68 and 163")
  legend(par()$usr[2],par()$usr[4],rownames(sub4.1)[2:1],fill=2:4,xpd=T)
  
  pred.CD68_163.1[pred.CD68_163=="DP"] <- "DP"
  pred.CD68_163.1 <- factor(pred.CD68_163.1,)
  
  tab3.1 <- table(mac_subtype=pred.CD68_163.1,sample=seurat_M$sample)
  sub3.1 <- array(tab3.1,dim(tab3.1))/colSums(tab3.1)[col(tab3.1)]
  dimnames(sub3.1) <- dimnames(tab3.1)
  par(mar=c(5,5,4,10))
  barplot(sub3.1[c(3,1,2),bots.used],las=2,col=4:2,main="split separately by 68 and 163 (DN removed)")
  legend(par()$usr[2],par()$usr[4],rownames(sub3.1)[c(2,1,3)],fill=2:4,xpd=T)
  
  ##
  DimPlot(seurat_M, group.by = "pred.CD68.CD163.cmbd", label=FALSE, reduction = "umap",raster=FALSE) +
    ggplot2::ggtitle("classification (ROC); CD68 or CD163 (prediction with glm)")  
  seurat_M$sample <- factor(seurat_M$sample,levels=bots.used)
  
  # DefaultAssay(seurat_M) <- "RNA"
  # VlnPlot(seurat_M,features=c("HLA-A"),group.by="sample")#c("pred.CD68.CD163.cmbd","sample"))
}
```

### updating macrophage phenotypes in `seurat_mac`
```{r}
pred.CD68_163 <- paste0("Mac_",pred.CD68_163)
seurat_M$celltype_broad <- factor(pred.CD68_163,levels=c("Mac_DN","Mac_CD68","Mac_CD163","Mac_DP"))

seurat_mac@meta.data$celltype_broad_v2 <- seurat_mac$celltype_broad
seurat_mac$celltype_broad_v2[names(seurat_M$celltype_broad)] <- as.character(seurat_M$celltype_broad)
seurat_mac$celltype_broad_v2[seurat_mac$celltype_broad_v2=="CTSK_TAM"] <- "Mac_CD68"
seurat_mac$celltype_broad_v2 <- factor(seurat_mac$celltype_broad_v2,
                                    levels=c("Mac_DN","Mac_CD68","Mac_CD163","Mac_DP"))
table(seurat_mac$celltype_broad,seurat_mac$celltype_broad_v2)
DimPlot(seurat_mac, group.by = "celltype_broad_v2", label=FALSE, reduction = "umap",raster=FALSE)  +
  ggplot2::ggtitle("seurat_mac (celltype_broad_updated)")
```


```{r}
if(0){
  idx.dn <- which(as.character(seurat_mac$celltype_broad_v2)!="Mac_DN")
  seurat_mac2 <- subset(seurat_mac,cells=names(seurat_mac$celltype_broad_v2)[idx.dn])
  DimPlot(seurat_mac2, group.by = "celltype_broad_v2", label=FALSE, reduction = "umap",raster=FALSE)  +
    ggplot2::ggtitle("seurat_mac (celltype_broad_updated; without DN)")
}
```

## Saving the processed macrophage data
```{r}
save(seurat_mac, file=file.path(obj_dir1, "seurat_sct_mac_KS.RData"))
save(seurat_M, file=file.path(obj_dir1, "seurat_sct_M_KS.RData"))
```
